---
import DemoLayout from "../../../../layouts/DemoLayout.astro";
import { getComponents } from "../../../../utils/components";
import { loadDemo } from "../../../../utils/demo-loader";
import { siteConfig } from "../../../../data/site";
import CodePanel from "../../../../components/CodePanel.astro";
import { getUsageSnippet } from "../../../../utils/readme.js";

const stripTag = (input, tag) =>
  input.replace(new RegExp(`<\\/?${tag}[^>]*>`, "gi"), "").trim();

const extractImportmaps = (scripts = "") => {
  const matches = scripts.match(/<script[^>]*type=["']?importmap["']?[^>]*>[\\s\\S]*?<\\/script>/gi);
  return matches ? matches.join("\n") : "";
};

const extractScripts = (scripts = "") => {
  const withoutImportmaps = scripts.replace(
    /<script[^>]*type=["']?importmap["']?[^>]*>[\\s\\S]*?<\\/script>/gi,
    ""
  );
  return stripTag(withoutImportmaps, "script");
};

const extractStyles = (styles = "") => stripTag(styles, "style");

const rewriteImports = (code = "", packageName = "") => {
  if (!code || !packageName) return code;
  return code
    .replace(/from\s+["']\.\.?\/src\/[^"']+["']/g, `from "https://esm.sh/${packageName}"`)
    .replace(/import\s+["']\.\.?\/src\/[^"']+["'];?/g, `import "https://esm.sh/${packageName}";`);
};

const codepenVars = `:root {
  --bg: #0c0f14;
  --bg-elevated: #141923;
  --bg-panel: #171d28;
  --border: #262f3f;
  --text: #f4f6fb;
  --text-muted: #a7b0c2;
  --text-dim: #7d879b;
  --accent: #ff8a3d;
  --accent-strong: #ff6a00;
  --accent-soft: rgba(255, 138, 61, 0.16);
  --shadow: 0 20px 50px rgba(5, 8, 14, 0.45);
  --radius-lg: 22px;
  --radius-md: 14px;
  --radius-sm: 10px;
  --max-width: 1160px;
}`;

export function getStaticPaths() {
  const components = getComponents();
  return components.map((component) => ({
    params: { slug: component.slug },
    props: { component },
  }));
}

const { component } = Astro.props;
const snippet = getUsageSnippet(component.slug);
const demo = loadDemo(component.slug, "demo");
const links = [
  { label: "‚Üê Back to components", href: siteConfig.basePath || "/" },
  { label: "GitHub Repo", href: siteConfig.repoUrl },
];

if (component.hasPlayground) {
  links.push({ label: "Playground", href: `../../${component.slug}/playground/` });
}

const demoHtml = demo ? [demo.links, demo.body].filter(Boolean).join("\n") : "";
const demoCss = demo ? extractStyles(demo.styles) : "";
const demoJs = demo ? extractScripts(demo.scripts) : "";
const codepenCss = demoCss ? `${codepenVars}\n\n${demoCss}` : codepenVars;
const codepenJs = rewriteImports(demoJs, component.packageName);
---
<DemoLayout title={component.title} subtitle={component.description} links={links}>
  {demo ? (
    <>
      {demo.links && <div set:html={demo.links} />}
      {demo.styles && <div set:html={demo.styles} />}
      <div class="demo-embed" set:html={demo.body} />
      {demo.scripts && <div set:html={demo.scripts} />}
    </>
  ) : (
    <p>No demo content found.</p>
  )}

  {snippet && <CodePanel code={snippet.code} language={snippet.language} label="Usage" />}

  {demo && (
    <details class="code-details">
      <summary>Demo code (CodePen-ready HTML, CSS, JS)</summary>
      {demoHtml && <CodePanel code={demoHtml} language="html" label="HTML" />}
      {codepenCss && <CodePanel code={codepenCss} language="css" label="CSS" />}
      {codepenJs && <CodePanel code={codepenJs} language="js" label="JS" />}
    </details>
  )}
</DemoLayout>
